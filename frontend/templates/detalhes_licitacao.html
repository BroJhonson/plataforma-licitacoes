{% extends "base.html" %}

{% block title %}Detalhes da Licitação - {{ dados.licitacao.numeroControlePNCP }}{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{{ url_for('buscar_licitacoes', **request.args) if request.args else url_for('home') }}" class="btn btn-secondary">« Voltar para a lista</a>
</div>

{% if dados and dados.licitacao %}
    {% set lic = dados.licitacao %}
    <div class="card mb-4">
        <div class="card-header">
            <h2>Detalhes da Licitação: {{ lic.objetoCompra | default('Não informado') }}</h2>
        </div>
        <div class="card-body">
            <h5 class="card-title">Número PNCP: {{ lic.numeroControlePNCP }}</h5>
            <p class="card-text"><strong>Órgão/Entidade:</strong> {{ lic.orgaoEntidadeRazaoSocial | default('N/I') }}</p>
            <p class="card-text"><strong>Unidade do Órgão:</strong> {{ lic.unidadeOrgaoNome | default('N/I') }} ({{ lic.unidadeOrgaoMunicipioNome | default('N/I') }}/{{ lic.unidadeOrgaoUfSigla | default('N/I') }})</p>
            <p class="card-text"><strong>Modalidade:</strong> {{ lic.modalidadeNome | default('N/I') }} (Código: {{ lic.modalidadeId | default('N/I') }})</p>
            <p class="card-text"><strong>Status:</strong> {{ lic.situacaoCompraNome | default('N/I') }} (ID: {{ lic.situacaoCompraId | default('N/I') }})</p>
            <p class="card-text"><strong>Data de Publicação PNCP:</strong> {{ lic.dataPublicacaoPncp | default('N/I') }}</p>
            <p class="card-text"><strong>Data de Atualização:</strong> {{ lic.dataAtualizacao | default('N/I') }}</p>
            <p class="card-text"><strong>Valor Total Estimado:</strong> R$ {{ "%.2f"|format(lic.valorTotalEstimado | float) if lic.valorTotalEstimado else 'Não Informado' }}</p>
            <p class="card-text"><strong>Informação Complementar:</strong> {{ lic.informacaoComplementar | default('Nenhuma') | nl2br }}</p> <!-- nl2br para quebras de linha -->
            {% if lic.link_portal_pncp %}
            <a href="{{ lic.link_portal_pncp }}" class="btn btn-primary" target="_blank">Ver no Portal PNCP</a>
            {% endif %}
        </div>
    </div>

    {% if dados.itens %}
    <div class="card mb-4">
        <div class="card-header">
            <h3>Itens da Licitação ({{ dados.itens | length }})</h3>
        </div>
        <div class="card-body">
            {% if dados.itens|length > 0 %}
            <ul class="list-group list-group-flush">
                {% for item in dados.itens %}
                <li class="list-group-item">
                    <strong>Item {{ item.numeroItem }}:</strong> {{ item.descricao | default('N/I') }} <br>
                    <small>
                        <strong>Quantidade:</strong> {{ item.quantidade | default('N/I') }} |
                        <strong>Valor Unitário Estimado:</strong> R$ {{ "%.2f"|format(item.valorUnitarioEstimado | float) if item.valorUnitarioEstimado else 'N/I' }} |
                        <strong>Valor Total Estimado do Item:</strong> R$ {{ "%.2f"|format(item.valorTotalEstimado | float) if item.valorTotalEstimado else 'N/I' }}
                    </small>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>Nenhum item encontrado para esta licitação.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if dados.arquivos %}
    <div class="card">
        <div class="card-header">
            <h3>Arquivos da Licitação ({{ dados.arquivos | length }})</h3>
        </div>
        <div class="card-body">
            {% if dados.arquivos|length > 0 %}
            <ul class="list-group list-group-flush">
                {% for arq in dados.arquivos %}
                <li class="list-group-item">
                    <a href="{{ arq.link_download }}" target="_blank">{{ arq.titulo | default('Arquivo sem título') }}</a>
                    <br><small>Tipo: {{ arq.tipoNome | default('N/I') }} | Data de Inclusão: {{ arq.dataInclusao | default('N/I') }}</small>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>Nenhum arquivo encontrado para esta licitação.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

{% else %}
    <div class="alert alert-warning">Não foi possível carregar os detalhes da licitação.</div>
{% endif %}
{% endblock %}